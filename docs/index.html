<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RSS News Site</title>
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --muted:#666; --border:#eee; --card:#fafafa;
      --primary:#0b57d0; --chip:#f1f5ff;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--fg);
         max-width:1100px;margin:20px auto;padding:0 14px;line-height:1.6}
    h1{margin:0 0 6px 0;font-size:22px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:14px}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;background:var(--card);border:1px solid var(--border);
             padding:12px;border-radius:12px;margin:14px 0}
    .group{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .label{color:var(--muted);font-size:13px}
    input[type="text"]{width:min(520px, 100%);padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px}
    select{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    .check{display:flex;gap:6px;align-items:center;font-size:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;user-select:none}
    .chip.active{border-color:var(--primary)}
    .stats{margin:10px 0;color:var(--muted);font-size:14px}
    .list{display:grid;grid-template-columns:1fr;gap:10px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-bottom:6px}
    .badge{background:#f6f6f6;border:1px solid var(--border);padding:2px 8px;border-radius:999px;color:#333}
    .title{font-size:16px;font-weight:650;margin:2px 0 6px 0}
    .title-zh{font-size:14px;color:#222;margin:0 0 8px 0}
    .placeholder{color:#999}
    .summary{font-size:14px;margin:0 0 6px 0}
    .summary-zh{font-size:14px;margin:0}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{border:1px solid var(--border);background:#fff;padding:8px 10px;border-radius:10px;cursor:pointer}
    button:hover{border-color:#cfcfcf}
    details{margin-top:10px}
    details summary{cursor:pointer;color:var(--primary)}
    footer{margin:18px 0 10px 0;color:var(--muted);font-size:13px}
    .warn{background:#fff7e6;border:1px solid #ffe1a6;padding:10px;border-radius:12px}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
  </style>
</head>

<body>
  <h1>ğŸ“° RSS News Site</h1>
  <div class="sub" id="status">åŠ è½½ä¸­â€¦</div>

  <div class="toolbar">
    <div class="group" style="flex:1">
      <div class="label">æœç´¢</div>
      <input id="q" type="text" placeholder="æœæ ‡é¢˜/æ‘˜è¦/ä¸­æ–‡ï¼ˆä¾‹å¦‚ï¼šå°æ¹¾ / ceasefire / ãƒˆãƒ©ãƒ³ãƒ—ï¼‰" />
    </div>

    <div class="group">
      <div class="label">æ’åº</div>
      <select id="sort">
        <option value="new">æœ€æ–°åœ¨å‰</option>
        <option value="old">æœ€æ—§åœ¨å‰</option>
      </select>
    </div>

    <div class="group">
      <label class="check">
        <input id="onlyZh" type="checkbox" />
        åªçœ‹æœ‰ä¸­æ–‡ç¿»è¯‘
      </label>
    </div>
  </div>

  <div class="chips" id="sourceChips"></div>
  <div class="stats" id="stats"></div>

  <div class="list" id="list"></div>

  <footer>
    <div class="warn">
      <div><b>è¯´æ˜</b>ï¼šé¡µé¢æ•°æ®æ¥è‡ªä»“åº“é‡Œçš„ <code>docs/news.json</code>ï¼Œç”± GitHub Actions æ¯å¤©è‡ªåŠ¨æ›´æ–°ã€‚</div>
      <div>å½“å‰â€œä¸­æ–‡ç¿»è¯‘â€å¯èƒ½å¯¹è‹±æ–‡æœ‰æ•ˆï¼ˆç¦»çº¿ enâ†’zh æ¨¡å‹ï¼‰ï¼Œæ—¥æ–‡ï¼ˆjaâ†’zhï¼‰å¯èƒ½æš‚æ— ç¦»çº¿æ¨¡å‹ï¼Œå› æ­¤ä¼šæ˜¾ç¤ºå ä½ã€‚</div>
    </div>
  </footer>

<script>
/** å°å·¥å…·ï¼šå®‰å…¨å¤„ç†å­—ç¬¦ä¸² */
function s(x){ return (x ?? "").toString(); }

/** æ˜¯å¦ç®—â€œæœ‰ä¸­æ–‡ç¿»è¯‘â€ */
function hasZh(it){
  const t = s(it.title_zh).trim();
  const a = s(it.summary_zh).trim();
  return (t && !t.includes("æœªç¿»è¯‘") && !t.includes("å ä½")) || (a && !a.includes("æœªç¿»è¯‘") && !a.includes("å ä½"));
}

/** ç”Ÿæˆæ¥æº chips */
function renderSourceChips(sources, activeSet){
  const wrap = document.getElementById("sourceChips");
  wrap.innerHTML = "";
  sources.forEach(src=>{
    const div = document.createElement("div");
    div.className = "chip" + (activeSet.has(src) ? " active" : "");
    div.textContent = src;
    div.onclick = ()=>{
      if(activeSet.has(src)) activeSet.delete(src);
      else activeSet.add(src);
      saveUiState(activeSet);
      applyAndRender();
    };
    wrap.appendChild(div);
  });

  // å…¨é€‰ / æ¸…ç©º
  const all = document.createElement("div");
  all.className = "chip";
  all.textContent = "å…¨é€‰";
  all.onclick = ()=>{
    activeSet.clear();
    sources.forEach(x=>activeSet.add(x));
    saveUiState(activeSet);
    applyAndRender();
  };
  wrap.appendChild(all);

  const none = document.createElement("div");
  none.className = "chip";
  none.textContent = "æ¸…ç©º";
  none.onclick = ()=>{
    activeSet.clear();
    saveUiState(activeSet);
    applyAndRender();
  };
  wrap.appendChild(none);
}

/** å¤åˆ¶åˆ°å‰ªè´´æ¿ */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    alert("å·²å¤åˆ¶ âœ…");
  }catch(e){
    alert("å¤åˆ¶å¤±è´¥ï¼ˆå¯èƒ½æµè§ˆå™¨æƒé™é™åˆ¶ï¼‰");
  }
}

let RAW = [];
let ACTIVE_SOURCES = new Set();
let ALL_SOURCES = [];

/** ä¿å­˜ UI çŠ¶æ€åˆ° localStorageï¼ˆä¸‹æ¬¡æ‰“å¼€è¿˜èƒ½è®°ä½ä½ çš„ç­›é€‰ï¼‰ */
function saveUiState(activeSet){
  localStorage.setItem("active_sources", JSON.stringify(Array.from(activeSet)));
}
function loadUiState(){
  try{
    const x = JSON.parse(localStorage.getItem("active_sources") || "[]");
    return new Set(x);
  }catch(e){
    return new Set();
  }
}

/** æ ¸å¿ƒï¼šè¿‡æ»¤ + æ¸²æŸ“ */
function applyAndRender(){
  const q = s(document.getElementById("q").value).trim().toLowerCase();
  const sort = document.getElementById("sort").value;
  const onlyZh = document.getElementById("onlyZh").checked;

  let arr = RAW.slice();

  // æ¥æºç­›é€‰
  if(ACTIVE_SOURCES.size > 0){
    arr = arr.filter(it => ACTIVE_SOURCES.has(s(it.source)));
  }

  // åªçœ‹æœ‰ä¸­æ–‡
  if(onlyZh){
    arr = arr.filter(it => hasZh(it));
  }

  // æœç´¢ï¼ˆtitle/title_zh/summary/summary_zh/link/source éƒ½æœï¼‰
  if(q){
    arr = arr.filter(it=>{
      const bag = [
        it.source, it.title, it.title_zh, it.summary, it.summary_zh, it.link
      ].map(s).join(" ").toLowerCase();
      return bag.includes(q);
    });
  }

  // æ’åºï¼ˆæŒ‰ published_ts æ•°å­—æ’ï¼›æ²¡æœ‰å°±æ”¾æœ«å°¾ï¼‰
  arr.sort((a,b)=>{
    const ta = Number(a.published_ts || 0);
    const tb = Number(b.published_ts || 0);
    return sort === "new" ? (tb - ta) : (ta - tb);
  });

  document.getElementById("stats").textContent =
    `å½“å‰æ˜¾ç¤º ${arr.length} æ¡ï¼ˆæ€»æ•°æ® ${RAW.length} æ¡ï¼‰ï½œæ¥æºç­›é€‰ï¼š${ACTIVE_SOURCES.size ? Array.from(ACTIVE_SOURCES).join(" / ") : "æ— ï¼ˆæ˜¾ç¤ºå…¨éƒ¨ï¼‰"}`;

  const list = document.getElementById("list");
  list.innerHTML = "";

  arr.forEach(it=>{
    const title = s(it.title);
    const titleZh = s(it.title_zh);
    const summary = s(it.summary);
    const summaryZh = s(it.summary_zh);

    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="meta">
        <span class="badge">${s(it.source) || "æœªçŸ¥æ¥æº"}</span>
        <span>${s(it.published) || ""}</span>
      </div>

      <div class="title"><a href="${s(it.link)}" target="_blank" rel="noopener">${title || "(æ— æ ‡é¢˜)"}</a></div>
      <div class="title-zh ${titleZh ? "" : "placeholder"}">${titleZh || "ï¼ˆä¸­æ–‡ç¿»è¯‘å ä½ï¼šæš‚æ— /æœªç¿»è¯‘ï¼‰"}</div>

      <div class="summary">${summary ? summary : "<span class='placeholder'>ï¼ˆæ— æ‘˜è¦ï¼‰</span>"}</div>
      <div class="summary-zh ${summaryZh ? "" : "placeholder"}">${summaryZh || "ï¼ˆä¸­æ–‡æ‘˜è¦å ä½ï¼šæš‚æ— /æœªç¿»è¯‘ï¼‰"}</div>

      <div class="actions">
        <button data-act="copy">å¤åˆ¶æ ‡é¢˜ï¼ˆåŸæ–‡+ä¸­æ–‡ï¼‰</button>
        <button data-act="open">æ‰“å¼€åŸæ–‡</button>
      </div>

      <details>
        <summary>æŸ¥çœ‹åŸå§‹å­—æ®µï¼ˆè°ƒè¯•ç”¨ï¼‰</summary>
        <pre style="white-space:pre-wrap;margin:8px 0 0 0;background:#f6f6f6;padding:10px;border-radius:10px;border:1px solid #eee">${s(JSON.stringify(it, null, 2))}</pre>
      </details>
    `;

    div.querySelector('button[data-act="copy"]').onclick = ()=>{
      const txt = `${title}\n${titleZh || "ï¼ˆä¸­æ–‡å ä½ï¼‰"}\n\næ‘˜è¦ï¼š${summary}\nä¸­æ–‡æ‘˜è¦ï¼š${summaryZh || "ï¼ˆä¸­æ–‡å ä½ï¼‰"}\n${s(it.link)}`;
      copyText(txt);
    };
    div.querySelector('button[data-act="open"]').onclick = ()=>{
      window.open(s(it.link), "_blank", "noopener");
    };

    list.appendChild(div);
  });
}

/** é¡µé¢å…¥å£ï¼šåŠ è½½ news.json */
async function boot(){
  const status = document.getElementById("status");
  try{
    const res = await fetch("./news.json?ts=" + Date.now());
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    RAW = (data.items || []);
    // sources
    ALL_SOURCES = Array.from(new Set(RAW.map(it=>s(it.source)).filter(Boolean))).sort();
    const saved = loadUiState();
    // å¦‚æœ saved ä¸ºç©ºï¼Œé»˜è®¤å…¨é€‰
    ACTIVE_SOURCES = saved.size ? saved : new Set(ALL_SOURCES);
    renderSourceChips(ALL_SOURCES, ACTIVE_SOURCES);

    status.textContent = `æœ€åæ›´æ–°ï¼š${s(data.updated_at) || "unknown"} ï½œ å…± ${RAW.length} æ¡`;
    applyAndRender();

    // ç»‘å®šæ§ä»¶äº‹ä»¶
    document.getElementById("q").addEventListener("input", ()=>applyAndRender());
    document.getElementById("sort").addEventListener("change", ()=>applyAndRender());
    document.getElementById("onlyZh").addEventListener("change", ()=>applyAndRender());

  }catch(e){
    status.textContent = "åŠ è½½å¤±è´¥ï¼š" + e;
  }
}

boot();
</script>
</body>
</html>

